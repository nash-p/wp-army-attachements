namespace = wp_supports_army_hab
# Applies a buff/debuff to a general if >0.5 of his armies have good/bad habitability on planet
planet_event = {
	id = wp_supports_army_hab.2
	is_triggered_only = yes
	hide_window = yes
	immediate = {
		log = "WP_SUPPORTS.LOG: Started EVENT:wp_supports_army_hab.2"
		set_variable = {
			which = num_atk_army_planet_var
			value = 0
		}
		# Counts the number of attacking armies on a planet, that have a species and not robots
		every_ground_combat_attacker = {
			limit = {
				exists = leader
				exists = species
				species = {
					is_robotic = no
				}
			}
			leader = {
				save_event_target_as = attacking_general
			}
			root = {
				change_variable = {
					which = num_atk_army_planet_var
					value = 1
				}
			}
		}
		# Creates a var to check if up to half the attackers army has met the hab requirements
		set_variable = {
			which = half_num_atk_army_planet_var
			value = num_atk_army_planet_var
		}
		multiply_variable = {
			which = half_num_atk_army_planet_var
			value = @wp_army_supports_hab_army_percentage
		}
		if = {
			limit = {
				count_ground_combat_attacker = {
					count = half_num_atk_army_planet_var
					limit = {
						habitability = {
							who = this
							value > @wp_army_supports_hab_bonus_min
						}
					}
				}
			}
			event_target:attacking_general = {
				add_trait = support_trait_hab_bonus
				set_leader_flag = wp_hab_attacking_general_flag
				log = "WP_SUPPORTS.LOG: Added modifier trait wp_army_hab_bonus"
			}
		}
		if = {
			limit = {
				count_ground_combat_attacker = {
					count = half_num_atk_army_planet_var
					limit = {
						habitability = {
							who = this
							value < @wp_army_supports_hab_debuff_min
						}
					}
				}
			}
			event_target:attacking_general = {
				add_trait = support_trait_hab_malus
				set_leader_flag = wp_hab_attacking_general_flag
				log = "WP_SUPPORTS.LOG: Added modifier trait wp_army_hab_malus"
			}
		}
	}
}

# Iterates through every commander of a attacking country after the end of ground combat
# Checks if the commander has the flag OR buff/debuff trait, removes both
country_event = {
	id = wp_supports_army_hab.3
	is_triggered_only = yes
	hide_window = yes
	immediate = {
		every_owned_leader = {
			limit = {
				leader_class = commander
				# if he is on a planet, make sure he isn't in combat
				OR = {
					AND = {
						exists = planet
						planet = {
							has_ground_combat = no
						}
					}
				}
				# this is probably a double check but :shrug:
				OR = {
					has_trait = support_trait_hab_bonus
					has_trait = support_trait_hab_malus
					has_leader_flag = wp_hab_attacking_general_flag
				}
			}
			remove_trait = support_trait_hab_bonus
			remove_trait = support_trait_hab_malus
			remove_leader_flag = wp_hab_attacking_general_flag
		}
	}
}
